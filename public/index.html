<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>古树名木互动地图（离线瓦片版）</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; background:#f3f4f6; }
    .topbar { position: absolute; top: 12px; left: 12px; z-index: 1000; background: rgba(255,255,255,.95); padding: 10px 12px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,.15); }
    .topbar input { width: 260px; padding: 6px 8px; border: 1px solid #ddd; border-radius: 6px; }
    .chip { display: inline-block; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 999px; padding: 2px 8px; margin-left: 8px; font-size: 12px; }
  </style>
</head>
<body>
  <div class="topbar">
    <strong>古树名木互动地图</strong>
    <span class="chip">底图：离线 ESRI 瓦片</span><br/>
    <input id="filter" placeholder="按树种中文名搜索（回车确认）"/>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    // ⚠️ 注意：这里需要替换为你的 GeoJSON 数据，或用 fetch 加载文件
    const data = { "type": "FeatureCollection", "features": [] };

    const map = L.map('map', {
      center: [48.686146, 87.031124],
      zoom: 12,
      preferCanvas: true
    });

    // ✅ 使用本地瓦片 (QGIS 导出目录：public/tiles/{z}/{x}/{y}.jpg)
    const offlineTiles = L.tileLayer('./tiles/{z}/{x}/{y}.jpg', {
      minZoom: 6,
      maxZoom: 16,   // 改成你导出的最高缩放级别
      attribution: 'Imagery © Esri'
    }).addTo(map);

    // 聚合点位
    let cluster = L.markerClusterGroup({
      spiderfyOnMaxZoom: false,
      disableClusteringAtZoom: 16,
      chunkedLoading: true
    });
    map.addLayer(cluster);

    function renderMarkers(filterText) {
      cluster.clearLayers();
      const ft = (filterText || '').trim().toLowerCase();
      const layers = [];
      data.features.forEach(f => {
        const [lng, lat] = f.geometry.coordinates;
        const p = f.properties || {};
        const title = p.species || '古树';

        if (ft) {
          const hay = (p.species || '').toLowerCase();
          if (!hay.includes(ft)) return;
        }

        const marker = L.marker([lat, lng], { title });
        const html = `
          <b>${title}</b><br/>
          树龄：${p.age ?? '未知'}<br/>
          树高：${p.height ?? '未知'} 米<br/>
          胸围：${p.girth ?? '未知'} 厘米<br/>
          坐标：${lat.toFixed(6)}, ${lng.toFixed(6)}
        `;
        marker.bindPopup(html);
        layers.push(marker);
      });
      cluster.addLayers(layers);
    }

    renderMarkers('');
    document.getElementById('filter').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') renderMarkers(e.target.value);
    });
  </script>
</body>
</html>
